<VirtualHost *:80>
    ServerName omeusitio.lan

    DocumentRoot /opt/web/omeusitio.lan/htdocs

    <Directory /opt/web/omeusitio.lan/htdocs>
        Require all granted

        # Configurar .htaccess
        AllowOverride AuthConfig FileInfo Nonfatal=Override

        # Habilitar directory listing
        # DirectoryIndex disabled
        Options Indexes
    </Directory>


    <Directory /opt/web/omeusitio.lan/htdocs/datos>
        # AllowOverride AuthConfig
        # Files y Filesmatch no tienen un Override, solo ALL
        AllowOverride AuthConfig Nonfatal=Override
    </Directory>

    <Directory /opt/web/omeusitio.lan/htdocs/imaxes>
        # AllowOverride AuthConfig
        # Files y Filesmatch no tienen un Override, solo ALL
        AllowOverrideList Files FilesMatch Nonfatal=Override
    </Directory>

    # Configurar autenticación Basic
    <Directory /opt/web/omeusitio.lan/htdocs/traballadores>
        # Indicar el tipo de autenticación
        # Módulo tipo de autenticación: mod_auth_basic
        AuthType Basic

        # Mensaje que aparecerá en el prompt de autenticación del navegador 
        AuthName "Restricted Files"

        # Indicar el método que se emplea para almacenar las contraseñas
        # Módulo proveedor de autenticación: mod_auth_basic
        AuthBasicProvider file

        # Indicar el fichero donde están almacenadas las contraseñas
        AuthUserFile /usr/local/apache/passwd/passwords

        # Indicar que usuarios pueden autenticarse. Tienen que existir
        # en el AuthUserFile
        # Módulo: mod_authz_user
        Require user ana
        Require user eva
    </Directory>

    # Configurar autenticación Digest
    # Módulo tipo de autenticación: mod_auth_digest
    <Directory /opt/web/omeusitio.lan/htdocs/directivos>
        AuthType Digest
        AuthName "directivos"
        AuthDigestProvider file
        AuthUserFile /opt/web/omeusitio.lan/.htdigestpasswords

        Require user xan
    </Directory>

    # Configurar autenticación basic en un fichero .htaccess 
    <Directory /opt/web/omeusitio.lan/contas>
        AllowOverride AuthConfig
    </Directory>

    # Responder con un 403 Forbidden a las peticiones que cumplan:
    #   - Subred: 172.16.0.0/16
    #   - Hostname: apache.lan
    # Funcionamineto de Requiere host:
    #   1. Resolución inversa de la IP del cliente.
    #   2. Resolver el nombre que ha obtenido, para comprobar que apunta a dicha IP.
    #   3. Volver a hacer una resolución inversa, pero ahora de la IP obtenida en la
    #      resolución anterior.
    #   4. Comprobar que la IP con la que el cliente ha hecho la petición (paso 1)
    #      y la obtenida en el paso 3 coinciden
    <Directory /opt/web/omeusitio.lan/secure>
        <RequireAll>
            Require all granted
            <RequireNone>
                <RequireAny>
                    Require ip 172.16
                    Require host apache.lan
                </RequireAny>
            </RequireNone>
        </RequireAll>
    </Directory>


    # Control de acceso en el directorio /reservado
    <Directory /opt/web/omeusitio.lan/htdocs/reservado>
        AuthType Basic
        AuthName "Se requiere autenticación"
        AuthBasicProvider file
        AuthUserFile /opt/web/omeusitio.lan/.htcontas_passwords
        AuthGroupFile /opt/web/omeusitio.lan/.htbasicgroups

        <RequireAll>
            <RequireAny>
                Require user manolo
                <RequireAll>
                    Require group admin
                    <RequireAny>
                        Require group vendas
                        Require group comerciais
                    </RequireAny>
                </RequireAll>
            </RequireAny>
            <RequireNone>
                    Require group temporais
                    Require ip 192.168.58.59
            </RequireNone>
        </RequireAll>
    </Directory>
</VirtualHost>